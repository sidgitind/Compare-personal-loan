<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Interest Calculator</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Load Brython -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>
</head>
<body onload="brython()">

    <h1>Loan Interest Calculator</h1>
    
    <form id="loanForm">
        <div class="form-group">
            <label for="principal">Principal:</label>
            <input type="number" id="principal" required>
            <small>Enter the initial amount of the loan.</small>
        </div>
        
        <div class="form-group">
            <label for="tenure">Tenure (years):</label>
            <input type="number" id="tenure" required>
            <small>Enter the loan duration in years.</small>
        </div>

        <div class="option-container">
            <div class="form-section">
                <h3>Option 1</h3>
                <div class="form-group">
                    <label for="interest_rate1">Interest Rate (%):</label>
                    <input type="number" id="interest_rate1" step="0.01" required>
                    <small>Enter the annual interest rate for Option 1.</small>
                </div>
                <div class="form-group">
                    <label for="prepayments1">Part Payments (comma-separated):</label>
                    <input type="text" id="prepayments1" required>
                    <small>Enter the part payment amounts as a comma-separated list.</small>
                </div>
                <div class="form-group">
                    <label for="charges1">Part Payment Charges:</label>
                    <input type="text" id="charges1" placeholder="comma-separated ranges and rates, e.g., 13-24:4,25-36:3,37-72:2" required>
                    <small>These are the charges of the bank if you make a part payment based on how old the loan is.</small>
                </div>
                <div class="form-group">
                    <label for="min_part_payment1">Minimum Part Payment:</label>
                    <input type="number" id="min_part_payment1" required>
                    <small>Enter the minimum amount required for a part payment.</small>
                </div>
                <div class="form-group">
                    <label for="max_part_payment1">Maximum Part Payment:</label>
                    <input type="number" id="max_part_payment1" required>
                    <small>Enter the maximum amount allowed for a part payment.</small>
                </div>
                <div class="form-group">
                    <label for="max_annual_prepayments1">Maximum Annual Part Payments:</label>
                    <input type="number" id="max_annual_prepayments1" required>
                    <small>Enter the maximum number of part payments allowed per year.</small>
                </div>
            </div>

            <div class="form-section">
                <h3>Option 2</h3>
                <div class="form-group">
                    <label for="interest_rate2">Interest Rate (%):</label>
                    <input type="number" id="interest_rate2" step="0.01" required>
                    <small>Enter the annual interest rate for Option 2.</small>
                </div>
                <div class="form-group">
                    <label for="prepayments2">Part Payments (comma-separated):</label>
                    <input type="text" id="prepayments2" required>
                    <small>Enter the part payment amounts as a comma-separated list.</small>
                </div>
                <div class="form-group">
                    <label for="charges2">Part Payment Charges:</label>
                    <input type="text" id="charges2" placeholder="comma-separated ranges and rates, e.g., 13-24:4,25-36:3,37-72:2" required>
                    <small>These are the charges of the bank if you make a part payment based on how old the loan is.</small>
                </div>
                <div class="form-group">
                    <label for="min_part_payment2">Minimum Part Payment:</label>
                    <input type="number" id="min_part_payment2" required>
                    <small>Enter the minimum amount required for a part payment.</small>
                </div>
                <div class="form-group">
                    <label for="max_part_payment2">Maximum Part Payment:</label>
                    <input type="number" id="max_part_payment2" required>
                    <small>Enter the maximum amount allowed for a part payment.</small>
                </div>
                <div class="form-group">
                    <label for="max_annual_prepayments2">Maximum Annual Part Payments:</label>
                    <input type="number" id="max_annual_prepayments2" required>
                    <small>Enter the maximum number of part payments allowed per year.</small>
                </div>
            </div>
        </div>
        
        <button type="button" id="calculateButton">Calculate Interest</button>
    </form>

    <div id="results">
        <h2>Results</h2>
        <p id="interest1">Total Interest for Option 1: </p>
        <p id="interest2">Total Interest for Option 2: </p>
    </div>

    <!-- Python code using Brython -->
    <script type="text/python">
        from browser import document, alert

        def parse_charges_format(format_str):
            """Parses the charges format string into a dictionary."""
            charges = {}
            try:
                entries = format_str.split(',')
                for entry in entries:
                    range_part, rate = entry.split(':')
                    rate = float(rate)
                    if '-' in range_part:
                        start, end = range_part.split('-')
                        end = int(end)
                        charges[(int(start), end)] = rate
                    else:
                        start = int(range_part)
                        charges[(start, float('inf'))] = rate
            except ValueError:
                alert("Error parsing the charges. Please use the format: 13-24:4,25-36:3,37-72:2")
            return charges

        def get_part_payment_charge(tenure, charges):
            """Determines the part payment charge based on the tenure."""
            for (start, end), rate in charges.items():
                if start <= tenure <= end:
                    return rate
            return 0  # Default if no range matches

        def calculate_interest(principal, interest_rate, tenure, part_payments, charges, min_part_payment, max_part_payment, max_annual_prepayments):
            """Calculates total interest paid based on given parameters."""
            balance = principal
            total_interest = 0
            part_payments_made = 0
            annual_prepayments_made = 0

            for year, part_payment in enumerate(part_payments):
                if part_payments_made >= max_annual_prepayments or part_payment == 0:
                    continue

                interest = balance * interest_rate
                total_interest += interest
                balance += interest

                if annual_prepayments_made < max_annual_prepayments:
                    adjusted_part_payment = max(min(part_payment, max_part_payment), min_part_payment)
                    part_payment_charge = get_part_payment_charge(tenure, charges)
                    total_interest += adjusted_part_payment * part_payment_charge / 100
                    balance -= adjusted_part_payment
                    part_payments_made += 1
                    annual_prepayments_made += 1

                if year % 12 == 0:
                    annual_prepayments_made = 0

            for remaining_year in range(year + 1, tenure):
                interest = balance * interest_rate
                total_interest += interest
                balance += interest

            return total_interest

        def calculateInterest(event):
            """Handles the click event for calculating interest."""
            try:
                principal = float(document["principal"].value)
                interest_rate1 = float(document["interest_rate1"].value) / 100
                interest_rate2 = float(document["interest_rate2"].value) / 100
                tenure = int(document["tenure"].value)

                part_payments1 = list(map(float, document["prepayments1"].value.split(',')))
                part_payments2 = list(map(float, document["prepayments2"].value.split(',')))

                charges1 = parse_charges_format(document["charges1"].value)
                charges2 = parse_charges_format(document["charges2"].value)

                min_part_payment1 = float(document["min_part_payment1"].value)
                max_part_payment1 = float(document["max_part_payment1"].value)
                max_annual_prepayments1 = int(document["max_annual_prepayments1"].value)

                min_part_payment2 = float(document["min_part_payment2"].value)
                max_part_payment2 = float(document["max_part_payment2"].value)
                max_annual_prepayments2 = int(document["max_annual_prepayments2"].value)

                total_interest1 = calculate_interest(principal, interest_rate1, tenure, part_payments1, charges1, min_part_payment1, max_part_payment1, max_annual_prepayments1)
                total_interest2 = calculate_interest(principal, interest_rate2, tenure, part_payments2, charges2, min_part_payment2, max_part_payment2, max_annual_prepayments2)

                document["interest1"].text = f"Total Interest for Option 1: {total_interest1:.2f}"
                document["interest2"].text = f"Total Interest for Option 2: {total_interest2:.2f}"

            except ValueError:
                alert("Error in the input values. Please check your entries and try again.")

        # Bind calculate function to button click
        document["calculateButton"].bind("click", calculateInterest)
    </script>

</body>
</html>
